# ì—´ë‹¤ (Yeolda) - ì•„í‚¤í…ì²˜ ë¬¸ì„œ

## ğŸ“ ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Android ì‹œìŠ¤í…œ                            â”‚
â”‚                    (ì•Œë¦¼ ë°œìƒ: ì¹´ì¹´ì˜¤í†¡, ìœ íŠœë¸Œ ë“±)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ Android Notification
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   NotificationListenerService                    â”‚
â”‚                     (Android Native Bridge)                      â”‚
â”‚                    EventChannelë¡œ Flutterì— ì „ë‹¬                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ Stream<IncomingNotification>
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Flutter Application                         â”‚
â”‚                         (bootstrap.dart)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â–¼                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Classifier  â”‚     â”‚   Database   â”‚
          â”‚  (ë¶„ë¥˜)      â”‚     â”‚  (ì €ì¥)       â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ NotificationRepo â”‚
                 â”‚  insertNotification()
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ success?
                           â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ EventBus.fire()  â”‚ â—„â”€â”€â”€ Producer
                 â”‚ (ì´ë²¤íŠ¸ ë°œí–‰)      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ NotificationEvent
                           â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ NotificationEventBus  â”‚ â—„â”€â”€â”€ Broker
                 â”‚ (Stream Controller)   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ Stream
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                   â–¼               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ TimelinePageâ”‚  â”‚  StatsPage  â”‚ â—„â”€â”€â”€ Consumers
          â”‚ (ìë™ ê°±ì‹ )  â”‚  â”‚  (í•„ìš”ì‹œ)    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”Œë¡œìš° (Event-Driven Architecture)

### 1ï¸âƒ£ ì•Œë¦¼ ìˆ˜ì‹  ë‹¨ê³„
```
Android Notification
  â†“
NotificationListenerService (Native)
  â†“
EventChannel
  â†“
NotificationListenerService.notificationStream (Dart)
```

### 2ï¸âƒ£ ì²˜ë¦¬ ë° ì €ì¥ ë‹¨ê³„
```
IncomingNotification
  â†“
ClassifierService.classify() â†’ CustomCategoryRepo ì¡°íšŒ
  â†“                              â†“
  â†“                         ì»¤ìŠ¤í…€ ì¹´í…Œê³ ë¦¬ í™•ì¸
  â†“                              â†“
AppCategory ê²°ì • â† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
NotificationRepo.insertNotification()
  â†“
Database (SQLite via Drift)
```

### 3ï¸âƒ£ ì´ë²¤íŠ¸ ë°œí–‰ ë‹¨ê³„ (Producer)
```
insertNotification() ì„±ê³µ
  â†“
NotificationEventBus.fire()
  â†“
NotificationEvent(type: newNotification)
  â†“
StreamController.add()
```

### 4ï¸âƒ£ UI ì—…ë°ì´íŠ¸ ë‹¨ê³„ (Consumer)
```
NotificationEventBus.stream
  â†“
TimelinePage.listenManual()
  â†“
event.type == newNotification?
  â†“ Yes
ref.invalidate(timelineProvider)
  â†“
íƒ€ì„ë¼ì¸ ìë™ ìƒˆë¡œê³ ì¹¨ âœ¨
```

---

## ğŸ“¦ ì£¼ìš” ì»´í¬ë„ŒíŠ¸

### Producer (ì´ë²¤íŠ¸ ìƒì„±ì)
- **bootstrap.dart**: `_startNotificationListener()`
- **ì—­í• **: DB ì €ì¥ ì„±ê³µ ì‹œ ì´ë²¤íŠ¸ ë°œí–‰
- **ì½”ë“œ**:
  ```dart
  if (success) {
    eventBus.fire(NotificationEvent(
      type: NotificationEventType.newNotification
    ));
  }
  ```

### Broker (ë©”ì‹œì§€ ì¤‘ê°œì)
- **notification_event_bus.dart**: `NotificationEventBus`
- **ì—­í• **: StreamControllerë¡œ ì´ë²¤íŠ¸ ì¤‘ê°œ
- **íŒ¨í„´**: Singleton + Broadcast Stream
- **ì½”ë“œ**:
  ```dart
  final _controller = StreamController<NotificationEvent>.broadcast();
  Stream<NotificationEvent> get stream => _controller.stream;
  void fire(NotificationEvent event) => _controller.add(event);
  ```

### Consumer (ì´ë²¤íŠ¸ ì†Œë¹„ì)
- **timeline_page.dart**: `_TimelinePageState`
- **ì—­í• **: ì´ë²¤íŠ¸ ê°ì§€ â†’ UI ê°±ì‹ 
- **ì½”ë“œ**:
  ```dart
  _eventSubscription = ref.listenManual(
    notificationEventStreamProvider,
    (previous, next) {
      next.whenData((event) {
        if (event.type == NotificationEventType.newNotification) {
          ref.invalidate(timelineProvider);
        }
      });
    },
  );
  ```

---

## ğŸ¯ ì„¤ê³„ ì›ì¹™

### 1. **Pub/Sub íŒ¨í„´**
- Producerì™€ Consumerê°€ ì§ì ‘ ì—°ê²°ë˜ì§€ ì•ŠìŒ
- EventBusê°€ ì¤‘ê°œí•˜ì—¬ ëŠìŠ¨í•œ ê²°í•© (Loose Coupling)

### 2. **Single Responsibility**
- NotificationListener: ì•Œë¦¼ ìˆ˜ì‹ ë§Œ
- Classifier: ë¶„ë¥˜ë§Œ
- EventBus: ì´ë²¤íŠ¸ ì „ë‹¬ë§Œ
- UI: í‘œì‹œë§Œ

### 3. **Reactive Programming**
- Stream ê¸°ë°˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
- Riverpod Providerë¡œ ìƒíƒœ ê´€ë¦¬

### 4. **ë©”ëª¨ë¦¬ ì•ˆì „ì„±**
- `listenManual` ì‚¬ìš©: initStateì—ì„œ êµ¬ë…
- `ProviderSubscription`: disposeì—ì„œ ì •ë¦¬
- `mounted` ì²´í¬: ìœ„ì ¯ ìƒëª…ì£¼ê¸° ê³ ë ¤

---

## ğŸ”‘ í•µì‹¬ ê¸°ìˆ 

| ê³„ì¸µ | ê¸°ìˆ  | ì—­í•  |
|------|------|------|
| Native | Android NotificationListenerService | ì‹œìŠ¤í…œ ì•Œë¦¼ ìˆ˜ì‹  |
| Bridge | Flutter MethodChannel/EventChannel | Native â†” Dart í†µì‹  |
| Stream | Dart Stream | ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬ |
| State | Riverpod | ìƒíƒœ ê´€ë¦¬ + Provider |
| Database | Drift (SQLite) | ë¡œì»¬ ë°ì´í„° ì €ì¥ |
| Event Bus | StreamController | ì•± ë‚´ ë©”ì‹œì§• |

---

## ğŸ“Š ë°ì´í„° í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ë°ì´í„° ë¼ì´í”„ì‚¬ì´í´                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Android Notification
   â†“ (Native)
2. EventChannel Stream
   â†“ (Platform Channel)
3. IncomingNotification Model
   â†“ (Dart Object)
4. ClassifierService
   â†“ (ë¶„ë¥˜ ë¡œì§)
5. ClassificationResult
   â†“ (category + customCategory)
6. Database (NotificationEntry)
   â†“ (ì˜êµ¬ ì €ì¥)
7. NotificationEvent
   â†“ (ì´ë²¤íŠ¸ ë°œí–‰)
8. EventBus Stream
   â†“ (ì‹¤ì‹œê°„ ì „íŒŒ)
9. UI Provider Invalidation
   â†“ (ìƒíƒœ ê°±ì‹ )
10. Widget Rebuild
    â†“ (í™”ë©´ ì—…ë°ì´íŠ¸)
11. User Interface âœ¨
```

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### 1. **autoDispose**
```dart
final timelineProvider = FutureProvider.autoDispose.family(...)
```
- í™”ë©´ì„ ë²—ì–´ë‚˜ë©´ ìë™ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ í•´ì œ

### 2. **Broadcast Stream**
```dart
StreamController<NotificationEvent>.broadcast()
```
- ì—¬ëŸ¬ Consumerê°€ ë™ì‹œì— êµ¬ë… ê°€ëŠ¥

### 3. **Debounce/Throttle**
- ë¹ ë¥¸ ì—°ì† ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹œ ê³ ë ¤ ì‚¬í•­
- í˜„ì¬ëŠ” DB ì €ì¥ ì„±ê³µ ì‹œì—ë§Œ ë°œí–‰í•˜ë¯€ë¡œ ë¶ˆí•„ìš”

### 4. **Caching**
```dart
CategoryUtils.updateCustomCategoryCache(categories)
```
- ì»¤ìŠ¤í…€ ì¹´í…Œê³ ë¦¬ë¥¼ ë©”ëª¨ë¦¬ì— ìºì‹œí•˜ì—¬ DB ì¡°íšŒ ìµœì†Œí™”

---

## ğŸ” ë””ë²„ê¹… ê°€ì´ë“œ

### ì´ë²¤íŠ¸ê°€ ë°œí–‰ë˜ì§€ ì•ŠëŠ” ê²½ìš°
1. **ë¡œê·¸ í™•ì¸**:
   ```
   ì•Œë¦¼ ìˆ˜ì‹ : ...
   DB ì €ì¥ ì™„ë£Œ
   ğŸ”” ì´ë²¤íŠ¸ ë°œí–‰: newNotification
   ```

2. **ì›ì¸**:
   - DB ì €ì¥ ì‹¤íŒ¨ (ì¤‘ë³µ ì•Œë¦¼)
   - EventBusê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ

### UIê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠëŠ” ê²½ìš°
1. **ë¡œê·¸ í™•ì¸**:
   ```
   ğŸ”„ ìƒˆ ì•Œë¦¼ ê°ì§€ - íƒ€ì„ë¼ì¸ ìë™ ìƒˆë¡œê³ ì¹¨
   ```

2. **ì›ì¸**:
   - Consumerê°€ êµ¬ë…í•˜ì§€ ì•ŠìŒ
   - ìœ„ì ¯ì´ disposeë¨ (mounted ì²´í¬)
   - Providerê°€ invalidateë˜ì§€ ì•ŠìŒ

---

## ğŸ“ ì¶”ê°€ ê°œì„  ê°€ëŠ¥ ì‚¬í•­

### 1. **ì´ë²¤íŠ¸ íƒ€ì… í™•ì¥**
```dart
enum NotificationEventType {
  newNotification,  // ìƒˆ ì•Œë¦¼
  updated,          // ì½ìŒ ì²˜ë¦¬
  deleted,          // ì‚­ì œ
  categoryChanged,  // ì¹´í…Œê³ ë¦¬ ë³€ê²½
}
```

### 2. **ì—¬ëŸ¬ Consumer ì¶”ê°€**
- StatsPage: í†µê³„ ìë™ ê°±ì‹ 
- CategoriesPage: ì¹´í…Œê³ ë¦¬ë³„ ì•Œë¦¼ ìˆ˜ ê°±ì‹ 
- Badge: ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜ í‘œì‹œ

### 3. **ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”**
```dart
eventBus.stream.handleError((error) {
  // ì—ëŸ¬ ë¡œê¹… ë° ë³µêµ¬
});
```

### 4. **ì´ë²¤íŠ¸ íˆìŠ¤í† ë¦¬**
```dart
List<NotificationEvent> _eventHistory = [];
```
- ë””ë²„ê¹…ìš© ì´ë²¤íŠ¸ ê¸°ë¡

---

## ğŸ“ í•™ìŠµ ìë£Œ

### Kafka vs EventBus ë¹„êµ

| íŠ¹ì§• | Kafka (ì„œë²„ìš©) | EventBus (ëª¨ë°”ì¼ìš©) |
|------|----------------|---------------------|
| ê·œëª¨ | ë¶„ì‚° ì‹œìŠ¤í…œ | ë‹¨ì¼ ì•± |
| ë³µì¡ë„ | ë†’ìŒ | ë‚®ìŒ |
| ì¸í”„ë¼ | ì„œë²„ í•„ìš” | ì•± ë‚´ì¥ |
| ì§€ì†ì„± | ë””ìŠ¤í¬ ì €ì¥ | ë©”ëª¨ë¦¬ (ì„ íƒì ) |
| ì²˜ë¦¬ëŸ‰ | ë§¤ìš° ë†’ìŒ | ì¶©ë¶„í•¨ |
| ì§€ì—°ì‹œê°„ | ë„¤íŠ¸ì›Œí¬ ì˜ì¡´ | ì¦‰ì‹œ |

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- [Flutter EventChannel](https://api.flutter.dev/flutter/services/EventChannel-class.html)
- [Riverpod listenManual](https://riverpod.dev/docs/concepts/reading#listenmanual)
- [Dart Streams](https://dart.dev/tutorials/language/streams)
- [Pub/Sub Pattern](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern)

---

**ì‘ì„±ì¼**: 2025-10-19  
**ë²„ì „**: 1.0.0  
**ì‘ì„±ì**: AI Assistant
